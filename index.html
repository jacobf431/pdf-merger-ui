<form id="uploadForm">
  <input type="file" id="fileInput" required />
  <input type="email" id="emailInput" placeholder="Your email" required />
  <button type="submit">Upload File</button>
</form>

<p id="status"></p>

<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const file = document.getElementById('fileInput').files[0];
  const email = document.getElementById('emailInput').value;
  if (!file || !email) return;

  document.getElementById('status').innerText = 'Requesting upload URL...';

  // Step 1: Get presigned URL from your Flask signer
  const signerRes = await fetch('https://upload.automatedairsy.com/get-presigned-url', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ filename: file.name })
  });

  const { uploadURL, key } = await signerRes.json();

  // Step 2: Upload file directly to Cloudflare R2
  document.getElementById('status').innerText = 'Uploading file...';
  await fetch(uploadURL, {
    method: 'PUT',
    body: file
  });

  // Step 3: Send file path + email to n8n webhook
  document.getElementById('status').innerText = 'Notifying server...';
  await fetch('https://automatedairsy.com/webhook/upload-docs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      filePath: key,
      email: email
    })
  });

  document.getElementById('status').innerText = 'Upload complete. Youâ€™ll receive your result via email.';
});
</script>
